
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Heavens Above — Auto Documentation</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; color: #333; padding: 20px; line-height: 1.5; }
    h1 { color: #2c3e50; }
    h2 { color: #16a085; margin-top: 40px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
    h3 { color: #34495e; margin-top: 20px; }
    pre { background: #f7f7f7; padding: 10px; border-radius: 8px; overflow-x: auto; font-size: 0.9em; }
    ul { list-style-type: none; padding: 0; }
    li { margin-bottom: 15px; }
    summary { cursor: pointer; color: #2980b9; }
  </style>
</head>
<body>
  <h1>Heavens Above — Function Reference</h1>
  <p>Automatically generated documentation from source files.</p>
<section><h2>iridium.js</h2><ul>
        <li>
          <h3>getTable(config)</h3>
          <pre>No description provided.</pre>
        </li>
        <li>
          <h3>factory(temp)</h3>
          <pre>No description provided.</pre>
        </li></ul><details><summary>View Source</summary><pre><code>const request = require("request");
const cheerio = require("cheerio");
const fs = require("fs");
const utils = require("./utils");

const eventsIridium = ["brightness", "altitude", "azimuth", "satellite", "distanceToFlareCentre", "brightnessAtFlareCentre", "date", "time", "distanceToSatellite", "AngleOffFlareCentre-line", "flareProducingAntenna", "sunAltitude", "angularSeparationFromSun", "image", "id"];

function getTable(config) {
	let database = config.database || [];
	let counter = config.counter || 0;
	const opt = config.opt || 0;
	const basedir = config.root + "IridiumFlares/";
	if (counter === 0) {
		options = utils.get_options("IridiumFlares.aspx?");
		if (!fs.existsSync(basedir)) {
			fs.mkdir(basedir, (err) =&gt; {
				if (err) console.log(err);
			});
		}
	} else {
		options = utils.post_options("IridiumFlares.aspx?", opt);
	}
	request(options, (error, response, body) =&gt; {
		if (error || response.statusCode !== 200) return;
		const $ = cheerio.load(body, {
			decodeEntities: false
		});
		let next = "__EVENTTARGET=&amp;__EVENTARGUMENT=&amp;__LASTFOCUS=";
		const tbody = $("form").find("table.standardTable tbody");
		const queue = [];
		tbody.find("tr").each((i, o) =&gt; {
			const temp = {};
			for (let i = 0; i &lt; 6; i++) {
				temp[eventsIridium[i]] = $(o).find("td").eq(i + 1).text();
			}
			temp["url"] = "https://www.heavens-above.com/" + $(o).find("td").eq(0).find("a").attr("href").replace("type=V", "type=A");
			queue.push(temp);
		});
		function factory(temp) {
			return new Promise((resolve, reject) =&gt; {
				request(utils.iridium_options(temp["url"]), (error, response, body) =&gt; {
					if (error || response.statusCode !== 200) { //在无SessionID时返回500
						reject(error);
						return;
					}
					console.log("Success", temp);
					const $ = cheerio.load(body, {
						decodeEntities: false
					});
					const table = $("form").find("table.standardTable"), tr = table.find("tbody tr");
					[
						[6, 0],
						[7, 1],
						[8, 6],
						[9, 7],
						[10, 9],
						[11, 10],
						[12, 11]
					].forEach((ele) =&gt; {
						temp[eventsIridium[ele[0]]] = tr.eq(ele[1]).find("td").eq(1).text();
					});
					temp[eventsIridium[13]] = "https://www.heavens-above.com/" + $("#ctl00_cph1_imgSkyChart").attr("src") //.replace("size=800", "size=1600");,
					const id = utils.md5(Math.random().toString()); //temp[eventsIridium[6]];
					temp[eventsIridium[14]] = id;
					fs.appendFile(basedir + id + ".html", table.html(), (err) =&gt; {
						if (err) console.log(err);
					}); //保存表格
					request.get(utils.image_options(temp[eventsIridium[13]])).pipe(fs.createWriteStream(basedir + id + ".png", {
						"flags": "a"
					})).on("error", (err) =&gt; {
						console.error(err);
					}); //下载图片
					resolve(temp);
				});
			});
		}
		Promise.allSettled(queue.map(temp =&gt; factory(temp))).then(results =&gt; {
			results = results.filter(p =&gt; p.status === "fulfilled").map(p =&gt; p.value);
			database = database.concat(results);
			$("form").find("input").each((i, o) =&gt; {
				if ($(o).attr("name") === "ctl00$cph1$btnPrev" || $(o).attr("name") === "ctl00$cph1$visible") return;
				else next += `&amp;${$(o).attr("name")}=${$(o).attr("value")}`;
			});
			next += "&amp;ctl00$cph1$visible=radioVisible";
			next = next.replace(/\+/g, "%2B").replace(/\//g, "%2F") //.replace(/\$/g, "%24");
				if (counter++ &lt; config.pages) {
				getTable({
					count: config.count,
					pages: config.pages,
					root: config.root,
					counter,
					opt: next,
					database
				});
			} else {
				fs.appendFile(basedir + "index.json", JSON.stringify(database), (err) =&gt; {
					if (err) console.log(err);
				});
			}
		});
	});
}

exports.getTable = getTable;
</code></pre></details></section><section><h2>satellite.js</h2><ul>
        <li>
          <h3>getTable(config)</h3>
          <pre>No description provided.</pre>
        </li>
        <li>
          <h3>factory(temp)</h3>
          <pre>No description provided.</pre>
        </li></ul><details><summary>View Source</summary><pre><code>const request = require("request");
const cheerio = require("cheerio");
const fs = require("fs");
const utils = require("./utils");

const property = ["url", "date", "brightness", "events", "passType", "image", "scoreData", "exist", "score", "id"];
const events = ["rise", "reachAltitude10deg", "highestPoint", "dropBelowAltitude10deg", "set", "exitShadow", "enterShadow"];
const attribute = ["time", "altitude", "azimuth", "distance", "brightness", "sunAltitude"];

const compare = [
    function(a, b) {
        return a[property[6]][1] &gt;= b[property[6]][1] ? 1 : -1;
    },
    function(a, b) {
        return a[property[6]][2] &gt;= b[property[6]][2] ? 1 : -1;
    },
    function(a, b) {
        return a[property[6]][3] &lt;= b[property[6]][3] ? 1 : -1;
    },
    function(a, b) {
        return a[property[7]] &lt;= b[property[7]] ? 1 : -1;
    }
];
const weight = [9.5, 6, 6.5, 6.5];

function getTable(config) {
    let database = config.database || [];
    let counter = config.counter || 0;
    const opt = config.opt || 0;
	const basedir = `public/data/satellite${config.target}/`;

    let options;

    if (counter === 0) {
        options = utils.get_options(`PassSummary.aspx?satid=${config.target}&amp;`);
        if (!fs.existsSync(basedir)) fs.mkdirSync(basedir, { recursive: true });
    } else {
        options = utils.post_options(`PassSummary.aspx?satid=${config.target}&amp;`, opt);
    }

    request(options, (error, response, body) =&gt; {
        if (error || response.statusCode !== 200) return;

        const $ = cheerio.load(body, { decodeEntities: false });
        let next = "__EVENTTARGET=&amp;__EVENTARGUMENT=&amp;__LASTFOCUS=";
        const tbody = $("form").find("table.standardTable tbody");
        const queue = [];

        tbody.find("tr").each((i, o) =&gt; {
            queue.push({
                [property[0]]: "https://www.heavens-above.com/" + $(o).find("td").eq(0).find("a").attr("href").replace("type=V", "type=A"),
                [property[1]]: $(o).find("td").eq(0).find("a").text(),
                [property[2]]: $(o).find("td").eq(1).text(),
                [property[3]]: {},
                [property[4]]: $(o).find("td").eq(11).text()
            });
        });

        function factory(temp) {
            return new Promise((resolve, reject) =&gt; {
                request(utils.image_options(temp[property[0]]), (error, response, body) =&gt; {
                    if (error || response.statusCode !== 200) return reject(error);

                    const $ = cheerio.load(body, { decodeEntities: false });
                    const table = $("form").find("table.standardTable");
                    const tbody = table.find("tbody");
                    let shift = 0;
                    let flag = false;
                    const data = [];
                    let current;

                    for (let i = 0; i &lt; tbody.find("tr").length; i++) {
                        if (tbody.find("tr").eq(i).find("td").eq(0).text() === "离开地影") {
                            temp[property[3]][events[5]] = {};
                            current = temp[property[3]][events[5]];
                            shift++;
                        } else if (tbody.find("tr").eq(i).find("td").eq(0).text() === "进入地影") {
                            temp[property[3]][events[6]] = {};
                            current = temp[property[3]][events[6]];
                            shift++;
                        } else {
                            temp[property[3]][events[i - shift]] = {};
                            current = temp[property[3]][events[i - shift]];
                        }
                        for (let j = 0; j &lt; 6; j++) {
                            current[attribute[j]] = tbody.find("tr").eq(i).find("td").eq(j + 1).text();
                        }
                        if (i - shift === 2 &amp;&amp; !flag) {
                            flag = true;
                            data[0] = parseInt(current[attribute[0]].split(":")[0]);
                            data[1] = parseFloat(current[attribute[4]]);
                            data[2] = parseFloat(current[attribute[5]].split("°")[0]);
                            data[3] = parseInt(current[attribute[1]].split("°")[0]);
                        }
                    }

                    const startTime = utils.getTimestamp(temp[property[3]][events[5]] ? temp[property[3]][events[5]][attribute[0]] : temp[property[3]][events[1]][attribute[0]]);
                    const endTime = utils.getTimestamp(temp[property[3]][events[6]] ? temp[property[3]][events[6]][attribute[0]] : temp[property[3]][events[3]][attribute[0]]);
                    temp[property[5]] = "https://www.heavens-above.com/" + $("#ctl00_cph1_imgViewFinder").attr("src");
                    temp[property[6]] = data;
                    temp[property[7]] = endTime - startTime;
                    temp[property[8]] = 0;
                    const id = utils.md5(Math.random().toString());
                    temp[property[9]] = id;

                    try {
                        fs.writeFileSync(basedir + id + ".html", table.html());
                    } catch (err) {
                        console.error("Error writing HTML:", err);
                    }

                    request.get(utils.image_options(temp[property[5]])).pipe(fs.createWriteStream(basedir + id + ".png")).on("error", err =&gt; {
                        console.error(err);
                    });

                    resolve(temp);
                });
            });
        }

        Promise.allSettled(queue.map(temp =&gt; factory(temp))).then(results =&gt; {
            results = results.filter(p =&gt; p.status === "fulfilled").map(p =&gt; p.value);
            database = database.concat(results);

            $("form").find("input").each((i, o) =&gt; {
                if ($(o).attr("name") === "ctl00$cph1$btnPrev" || $(o).attr("name") === "ctl00$cph1$visible") return;
                next += `&amp;${$(o).attr("name")}=${$(o).attr("value")}`;
            });

            next += "&amp;ctl00$cph1$visible=radioVisible";
            next = next.replace(/\+/g, "%2B").replace(/\//g, "%2F");

            if (counter++ &lt; config.pages) {
                getTable({
                    target: config.target,
                    pages: config.pages,
                    root: config.root,
                    counter,
                    opt: next,
                    database
                });
            } else {
                for (let i = 0; i &lt; 4; i++) {
                    database.sort(compare[i]);
                    database = database.map((ele, index) =&gt; {
                        ele[property[8]] += 100 * (1 - index / database.length) * weight[i];
                        return ele;
                    });
                }

                database = database.map((ele) =&gt; {
                    if (isNaN(ele[property[6]][1])) {
                        ele[property[8]] = 0;
                        return ele;
                    }
                    if (ele[property[6]][0] &gt;= 17 &amp;&amp; ele[property[6]][0] &lt;= 19) ele[property[8]] += 850;
                    else if (ele[property[6]][0] &gt;= 20 &amp;&amp; ele[property[6]][0] &lt;= 23) ele[property[8]] += 950;
                    else if (ele[property[6]][0] &gt;= 0 &amp;&amp; ele[property[6]][0] &lt;= 3) ele[property[8]] += 400;
                    else if (ele[property[6]][0] &gt;= 4 &amp;&amp; ele[property[6]][0] &lt;= 6) ele[property[8]] += 300;

                    ele[property[8]] = Math.floor(ele[property[8]] / 40);
                    return ele;
                });

                database.sort((a, b) =&gt; (a[property[8]] &lt;= b[property[8]] ? 1 : -1));

                try {
                    fs.writeFileSync(basedir + "index.json", JSON.stringify(database, null, 2));
                    console.log(`index.json written successfully at ${basedir}`);
                } catch (err) {
                    console.error("Error writing index.json:", err);
                }
            }
        });
    });
}

exports.getTable = getTable;
</code></pre></details></section><section><h2>utils.js</h2><ul>
        <li>
          <h3>getTimestamp(time)</h3>
          <pre>No description provided.</pre>
        </li>
        <li>
          <h3>post_options(target, opt)</h3>
          <pre>No description provided.</pre>
        </li>
        <li>
          <h3>get_options(target)</h3>
          <pre>No description provided.</pre>
        </li>
        <li>
          <h3>image_options(target)</h3>
          <pre>No description provided.</pre>
        </li>
        <li>
          <h3>iridium_options(target)</h3>
          <pre>No description provided.</pre>
        </li>
        <li>
          <h3>md5(str)</h3>
          <pre>No description provided.</pre>
        </li></ul><details><summary>View Source</summary><pre><code>const crypto = require('crypto');

function getTimestamp(time) {
	const arr = time.split(":");
	return parseInt(arr[0]) * 3600 + parseInt(arr[1]) * 60 + parseInt(arr[2]);
}

function post_options(target, opt) {
	return {
		url: `https://www.heavens-above.com/${target}lat=39.9042&amp;lng=116.4074&amp;loc=%E5%8C%97%E4%BA%AC%E5%B8%82&amp;alt=52&amp;tz=ChST`,
		method: "POST",
		json: true,
		body: opt,
		headers: {
			"Host": "www.heavens-above.com",
			"Connection": "keep-alive",
			"Cache-Control": "max-age=0",
			"Origin": "https://www.heavens-above.com",
			"Upgrade-Insecure-Requests": "1",
			"DNT": "1",
			"Content-Type": "application/x-www-form-urlencoded",
			"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Safari/605.1.15",
			"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
			"Accept-Encoding": "deflate, br",
			"Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
			"Cookie": "ASP.NET_SessionId=4swouj1mkd2nburls12t5ryx; preferences=showDaytimeFlares=True; userInfo=lat=39.9042&amp;lng=116.4074&amp;alt=52&amp;tz=ChST&amp;loc=%e5%8c%97%e4%ba%ac%e5%b8%82"
		}
	};
}

function get_options(target) {
	return {
		url: `https://www.heavens-above.com/${target}lat=39.9042&amp;lng=116.4074&amp;loc=%E5%8C%97%E4%BA%AC%E5%B8%82&amp;alt=52&amp;tz=ChST`,
		method: "GET",
		headers: {
			"Host": "www.heavens-above.com",
			"Connection": "keep-alive",
			"Upgrade-Insecure-Requests": "1",
			"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Safari/605.1.15",
			"DNT": "1",
			"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
			"Accept-Encoding": "deflate, br",
			"Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
			"Cookie": "ASP.NET_SessionId=4swouj1mkd2nburls12t5ryx; preferences=showDaytimeFlares=True; userInfo=lat=39.9042&amp;lng=116.4074&amp;alt=52&amp;tz=ChST&amp;loc=%e5%8c%97%e4%ba%ac%e5%b8%82"
		}
	};
}

function image_options(target) {
	return {
		url: target,
		method: "GET",
		headers: {
			"Host": "www.heavens-above.com",
			"Connection": "keep-alive",
			"Upgrade-Insecure-Requests": "1",
			"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Safari/605.1.15",
			"DNT": "1",
			"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
			"Accept-Encoding": "deflate, br",
			"Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
			"Cookie": "ASP.NET_SessionId=4swouj1mkd2nburls12t5ryx; preferences=showDaytimeFlares=True; userInfo=lat=39.9042&amp;lng=116.4074&amp;alt=52&amp;tz=ChST&amp;loc=%e5%8c%97%e4%ba%ac%e5%b8%82"
		}
	};
}

function iridium_options(target) {
	return {
		url: target,
		method: "GET",
		headers: {
			"Host": "www.heavens-above.com",
			"Connection": "keep-alive",
			"Cache-Control": "max-age=0",
			"Upgrade-Insecure-Requests": "1",
			"User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Safari/605.1.15",
			"DNT": "1",
			"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
			"Accept-Encoding": "deflate, br",
			"Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
			"Cookie": "ASP.NET_SessionId=4swouj1mkd2nburls12t5ryx; preferences=showDaytimeFlares=True; userInfo=lat=39.9042&amp;lng=116.4074&amp;alt=52&amp;tz=ChST&amp;loc=%e5%8c%97%e4%ba%ac%e5%b8%82"
		}
	};
}

function md5(str) {
	return crypto.createHash('md5').update(str).digest('hex');
}

module.exports = {
	getTimestamp,
	post_options,
	get_options,
	image_options,
	iridium_options,
	md5
};
</code></pre></details></section><section><h2>run.js</h2><p><em>No functions found.</em></p><details><summary>View Source</summary><pre><code>const satellite = require("./src/satellite");
const iridium = require("./src/iridium");

var location = [39.9042, 116.4074, "%E5%8C%97%E4%BA%AC%E5%B8%82", 52, "ChST"];
//COOKIE需要先通过浏览器调到中文

//const names = ["ISS", "IridiumFlares"];
// https://www.heavens-above.com/PassSummary.aspx?satid=41765&amp;lat=0&amp;lng=0&amp;loc=Unspecified&amp;alt=0&amp;tz=UCT

satellite.getTable({
	target: 25544,
	pages: 4,
	root: "./public/data/"
}); //ISS
/*
iridium.getTable({
	pages: 4,
	root: "./public/data/"
});
*/
</code></pre></details></section>
</body>
</html>
